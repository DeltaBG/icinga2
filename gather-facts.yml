---
- name: Gather facts for all hosts and set facts for autodetection.
  hosts:
    - clients
    - master
  serial: '{{ icinga2_serial|default("0") }}'
  gather_facts: True
  tasks:
    - name: Gather extended facts.
      mlg1.extended_facts.extended_facts:
    - set_fact:
        plugin_iostats_autodetect_enabled: True
      when: >
        (ansible_devices.keys()|list is defined and
        ansible_devices.keys()|list|length>0) and
        icinga2_plugin_autodetect
    - set_fact:
        plugin_disk_autodetect_enabled: True
      when: >
        (ansible_facts.mounts is defined 
        and ansible_facts.mounts|length>0) and
        icinga2_plugin_autodetect
    - set_fact:
        plugin_swap_autodetect_enabled: True
      when: >
        (ansible_facts.swaptotal_mb is defined 
        and ansible_facts.swaptotal_mb>0) and 
        icinga2_plugin_autodetect
    - set_fact:
        plugin_load_autodetect_enabled: True
      when: >
        ansible_facts.processor_vcpus is defined and
        icinga2_plugin_autodetect
    - set_fact:
        plugin_smartctl_autodetect_enabled: True
      when: >
        (ansible_facts.smartctl is defined and
        ansible_facts.smartctl|length>0) and
        icinga2_plugin_autodetect
    - set_fact:
        plugin_raid_autodetect_enabled: True
      when: >
        (ansible_facts.raid is defined and 
        ansible_facts.raid|length>0) and
        icinga2_plugin_autodetect
    - set_fact:
        plugin_rbl_autodetect_enabled: True
      when: >
        (ansible_facts.all_ipv4_addresses is defined and 
        ansible_facts.all_ipv4_addresses|length>0) and
        icinga2_plugin_autodetect
    - set_fact:
        plugin_mysql_autodetect_enabled: True
      when: >
        (ansible_facts.mysql is defined and 
        ansible_facts.mysql|length>0) and
        icinga2_plugin_autodetect
    - set_fact:
        plugin_mem_autodetect_enabled: True
      when: >
        (ansible_memory_mb is defined and 
        ansible_memory_mb.real.total|int > 0) and
        icinga2_plugin_autodetect
  tags: always
